{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<style>
/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    overflow: auto;
}

.modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    padding: 0;
    border: none;
    border-radius: 12px;
    width: 95%;
    max-width: 1200px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
}

.close:hover {
    color: #f1f1f1;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    background-color: #f8f9fa;
    padding: 15px 20px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-top: 1px solid #dee2e6;
}

/* Preview Summary Styles */
.preview-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.stat-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
    min-width: 150px;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 5px;
}

.stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: 600;
    color: #495057;
}

.preview-errors {
    margin: 15px 0;
    padding: 15px;
    border-radius: 8px;
    background-color: #f8d7da;
    border-left: 4px solid #dc3545;
}

.preview-errors h4 {
    margin: 0 0 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.preview-errors ul {
    margin: 0;
    padding-left: 20px;
}

/* Preview Table Styles */
.preview-table-container {
    overflow-x: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.preview-table th {
    background-color: #f8f9fa;
    padding: 12px 8px;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    position: sticky;
    top: 0;
    z-index: 10;
}

.preview-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #dee2e6;
    vertical-align: top;
}

.preview-table tr:hover {
    background-color: #f8f9fa;
}

/* Status Badge Styles */
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
}

.status-valid {
    background-color: #d4edda;
    color: #155724;
}

.status-error {
    background-color: #f8d7da;
    color: #721c24;
}

.preview-table tr.status-error {
    background-color: #fdf2f2;
}

.preview-table tr.status-valid {
    background-color: #f0f9f0;
}
</style>
<div class="bulk-operations-container">
    <div class="bulk-row">
        <div class="bulk-col-12">
            <div class="bulk-card">
                <div class="bulk-card-header">
                    <h1 class="bulk-card-title">ðŸ“¦ Stock Update</h1>
                    <p class="bulk-card-subtitle">Update stock quantities via CSV upload</p>
                </div>
                <div class="bulk-card-body">
                        <form method="post" enctype="multipart/form-data" id="stockUpdateForm">
                            {% csrf_token %}
                            
                        <div class="bulk-row">
                            <div class="bulk-col-6">
                                <!-- Platform Selection -->
                                <div class="bulk-form-group">
                                    <label for="platform" class="bulk-form-label">
                                        <i class="bx bx-store"></i> Select Platform
                                    </label>
                                    <select class="bulk-form-control" id="platform" name="platform" required>
                                        <option value="">Select Platform</option>
                                        <option value="pasons">Pasons Ecommerce</option>
                                        <option value="talabat">Talabat Platform</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="bulk-col-6">
                                <!-- Outlet Selection -->
                                <div class="bulk-form-group">
                                    <label for="outlet" class="bulk-form-label">
                                        <i class="bx bx-building"></i> Select Outlet
                                    </label>
                                    <select id="outlet" name="outlet" class="bulk-form-control" required>
                                        <option value="">Select a platform first</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Operation Selection -->
                        <div class="bulk-form-group">
                            <label for="operation" class="bulk-form-label">
                                <i class="bx bx-refresh"></i> Stock Operation
                            </label>
                            <select id="operation" name="operation" class="bulk-form-control" required>
                                <option value="">Choose Stock Operation...</option>
                                <option value="set">SET - Replace stock (new value)</option>
                            </select>
                        </div>

                            <!-- File Upload -->
                            <div class="bulk-form-group">
                                <label for="csvFile" class="bulk-form-label">
                                    <i class="bx bx-file"></i> Choose CSV File (Itemcode, Stock Quantity)
                                </label>
                                <div class="file-upload-container">
                                    <div class="file-upload-area" id="fileUploadArea">
                                        <input type="file" id="csvFile" name="csv_file" accept=".csv" class="file-input-hidden" required>
                                        <div class="upload-content">
                                            <i class="bx bx-cloud-upload upload-icon"></i>
                                            <div class="upload-text">Browse Files</div>
                                            <div class="upload-subtext">or drag and drop your CSV file here</div>
                                            <div class="upload-format">Supported format: .csv (Max size: 10MB)</div>
                                        </div>
                                    </div>
                                    <div id="selectedFile" class="selected-file-display" style="display: none;">
                                        <div class="file-preview">
                                            <div class="file-icon">
                                                <i class="bx bx-file-blank"></i>
                                            </div>
                                            <div class="file-details">
                                                <div class="file-name" id="fileName"></div>
                                                <div class="file-size" id="fileSize"></div>
                                                <div class="file-status">
                                                    <i class="bx bx-check-circle"></i>
                                                    <span>Ready to upload</span>
                                                </div>
                                            </div>
                                            <button type="button" class="remove-file-btn" id="removeFile">
                                                <i class="bx bx-trash"></i>
                                                <span>Delete</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="bulk-form-actions">
                                <button type="button" class="bulk-btn bulk-btn-outline" onclick="downloadSample()">
                                    <i class="bx bx-download"></i> Download Sample CSV
                                </button>
                                <button type="button" class="bulk-btn bulk-btn-outline" onclick="resetForm()">
                                    <i class="bx bx-reset"></i> Reset
                                </button>
                                <button type="button" class="bulk-btn bulk-btn-primary" id="previewBtn">
                                    <i class="bx bx-show"></i> Preview CSV
                                </button>
                                <button type="submit" class="bulk-btn bulk-btn-success" id="updateBtn">
                                    <i class="bx bx-upload"></i> Update Stock
                                </button>
                            </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="bx bx-show"></i> CSV Preview</h3>
            <span class="close" onclick="closePreviewModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="previewSummary" class="preview-summary"></div>
            <div id="previewTable" class="preview-table-container"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="bulk-btn bulk-btn-outline" onclick="closePreviewModal()">
                <i class="bx bx-x"></i>
                Cancel
            </button>
            <button type="button" class="bulk-btn bulk-btn-success" id="confirmUpdateBtn">
                <i class="bx bx-check"></i>
                Update Stock
            </button>
        </div>
    </div>
</div>


<script>
// File upload handling
const fileInput = document.getElementById('csvFile');
const uploadArea = document.querySelector('.file-upload-area');
const selectedFile = document.getElementById('selectedFile');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const removeFileBtn = document.getElementById('removeFile');

// Helper function to format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// File input change event
fileInput.addEventListener('change', handleFileSelect);

// Click to upload
uploadArea.addEventListener('click', () => fileInput.click());

// Drag and drop events
uploadArea.addEventListener('dragover', handleDragOver);
uploadArea.addEventListener('dragleave', handleDragLeave);
uploadArea.addEventListener('drop', handleDrop);

// Remove file button
removeFileBtn.addEventListener('click', removeFile);

function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) {
        // Validate file type
        if (!(file.type === 'text/csv' || file.name.endsWith('.csv'))) {
            showModal({ title: 'CSV Required', message: 'Please select a CSV file.', type: 'warning' });
            fileInput.value = '';
            return;
        }
        // Enforce 10MB max size
        if (file.size > 10 * 1024 * 1024) {
            showModal({ title: 'File Too Large', message: 'File size must be less than 10MB.', type: 'warning' });
            fileInput.value = '';
            return;
        }
        displayFileInfo(file);
    }
}

function handleDragOver(e) {
    e.preventDefault();
    uploadArea.classList.add('bulk-upload-dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    uploadArea.classList.remove('bulk-upload-dragover');
}

function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('bulk-upload-dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const file = files[0];
        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
            if (file.size > 10 * 1024 * 1024) {
            showModal({ title: 'File Too Large', message: 'File size must be less than 10MB.', type: 'warning' });
                return;
            }
            fileInput.files = files;
            displayFileInfo(file);
        } else {
            showModal({ title: 'CSV Required', message: 'Please select a CSV file.', type: 'warning' });
        }
    }
}

function displayFileInfo(file) {
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    uploadArea.style.display = 'none';
    selectedFile.style.display = 'block';
}

function removeFile() {
    fileInput.value = '';
    uploadArea.style.display = 'block';
    selectedFile.style.display = 'none';
}

// Reset form function
function resetForm() {
    document.getElementById('stockUpdateForm').reset();
    removeFile();
    // Reset outlet dropdown
    const outletSelect = document.getElementById('outlet');
    outletSelect.innerHTML = '<option value="">Select a platform first</option>';
}

function downloadSample() {
    // Create sample CSV content for stock updates
    // Item Code + Units combination is the unique identifier
    const csvContent = `item_code,units,stock
9900127,KGS,150
9900185,KGS,75
9900281,KGS,200`;
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'stock_update_sample.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Platform-based outlet filtering
document.getElementById('platform').addEventListener('change', function() {
    const platform = this.value;
    const outletSelect = document.getElementById('outlet');
    
    if (platform) {
        // Clear current outlet options and show loading
        outletSelect.innerHTML = '<option value="">Loading outlets...</option>';
        
        // Fetch outlets for selected platform
        fetch(`/integration/api/outlets-by-platform/?platform=${platform}`)
            .then(response => response.json())
            .then(data => {
                outletSelect.innerHTML = '<option value="">Select Outlet</option>';
                
                data.outlets.forEach(outlet => {
                    const option = document.createElement('option');
                    option.value = outlet.id;
                    option.textContent = `${outlet.name} - ${outlet.location}`;
                    outletSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching outlets:', error);
                outletSelect.innerHTML = '<option value="">Error loading outlets</option>';
            });
    } else {
        // Clear outlets when no platform is selected
        outletSelect.innerHTML = '<option value="">Select a platform first</option>';
    }
});

// Form validation helper
function validateForm() {
    const platform = document.getElementById('platform').value;
    const outlet = document.getElementById('outlet').value;
    const operation = document.getElementById('operation').value;
    const file = document.getElementById('csvFile').files[0];
    
    if (!platform) {
        showModal({ title: 'Platform Required', message: 'Please select a platform.', type: 'warning' });
        return false;
    }
    if (!outlet) {
        showModal({ title: 'Outlet Required', message: 'Please select an outlet.', type: 'warning' });
        return false;
    }
    if (!operation) {
        showModal({ title: 'Operation Required', message: 'Please select a stock operation.', type: 'warning' });
        return false;
    }
    if (!file) {
        showModal({ title: 'CSV Required', message: 'Please select a CSV file.', type: 'warning' });
        return false;
    }
    return true;
}

// Preview button handler
document.getElementById('previewBtn').addEventListener('click', function() {
    if (!validateForm()) return;
    
    const previewBtn = this;
    previewBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Loading...';
    previewBtn.disabled = true;
    
    const formData = new FormData(document.getElementById('stockUpdateForm'));
    formData.append('preview', 'true');
    
    fetch('/integration/stock-update/preview/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPreviewModal(data);
        } else {
            showModal({ title: 'Error', message: 'Error: ' + data.message, type: 'error' });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showModal({ title: 'Processing Error', message: 'Error processing CSV file.', type: 'error' });
    })
    .finally(() => {
        previewBtn.innerHTML = '<i class="bx bx-show"></i> Preview CSV';
        previewBtn.disabled = false;
    });
});

// Confirm update button
document.getElementById('confirmUpdateBtn').addEventListener('click', function() {
    closePreviewModal();
    document.getElementById('updateBtn').click();
});

// Show preview modal
function showPreviewModal(data) {
    const modal = document.getElementById('previewModal');
    const summaryDiv = document.getElementById('previewSummary');
    const tableDiv = document.getElementById('previewTable');
    
    const outletSelect = document.getElementById('outlet');
    const outletName = outletSelect.options[outletSelect.selectedIndex]?.text || 'Unknown';
    const platform = document.getElementById('platform').value;
    
    let summaryHtml = `
        <div class="preview-stats">
            <div class="stat-item">
                <span class="stat-label">Total Rows:</span>
                <span class="stat-value">${data.total_rows}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Preview Rows:</span>
                <span class="stat-value">${data.preview_rows}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Platform:</span>
                <span class="stat-value">${platform}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Outlet:</span>
                <span class="stat-value">${outletName}</span>
            </div>
        </div>
    `;
    
    if (data.errors && data.errors.length > 0) {
        summaryHtml += `
            <div class="preview-errors">
                <h4><i class="bx bx-error"></i> Errors:</h4>
                <ul>
                    ${data.errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    summaryDiv.innerHTML = summaryHtml;
    
    let tableHtml = `
        <table class="preview-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Status</th>
                    <th>Item Code</th>
                    <th>Units</th>
                    <th>Stock</th>
                    <th>Errors</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    if (data.rows && data.rows.length > 0) {
        data.rows.forEach(row => {
            const statusClass = row.status === 'valid' ? 'status-valid' : 'status-error';
            const statusBadge = `<span class="status-badge ${statusClass}">${row.status}</span>`;
            const errors = row.errors && row.errors.length > 0 ? row.errors.join(', ') : '';
            
            tableHtml += `
                <tr class="${statusClass}">
                    <td>${row.row_number}</td>
                    <td>${statusBadge}</td>
                    <td>${row.data.item_code || ''}</td>
                    <td>${row.data.units || ''}</td>
                    <td>${row.data.stock || ''}</td>
                    <td>${errors}</td>
                </tr>
            `;
        });
    }
    
    tableHtml += '</tbody></table>';
    tableDiv.innerHTML = tableHtml;
    modal.style.display = 'block';
}

function closePreviewModal() {
    document.getElementById('previewModal').style.display = 'none';
}

window.addEventListener('click', function(event) {
    const modal = document.getElementById('previewModal');
    if (event.target === modal) {
        closePreviewModal();
    }
});

// Form validation
document.getElementById('stockUpdateForm').addEventListener('submit', function(e) {
    if (!validateForm()) {
        e.preventDefault();
        return;
    }
    
    // Show loading state
    const updateBtn = document.getElementById('updateBtn');
    updateBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Processing...';
    updateBtn.disabled = true;
});
</script>
{% endblock %}