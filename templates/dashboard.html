{% extends 'base.html' %}

{% block title %}Pasons Dashboard - Modern Inventory Dashboard{% endblock %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<div id="talabat-dashboard-content">

<!-- Stats Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8">
    <div class="p-6 border rounded-lg hover:shadow-md transition-shadow" style="background-color: #FFFFFF; border-color: #C5C5C5; box-shadow: 0 1px 3px rgba(0,0,0,0.06);">
        <div class="flex items-center justify-between">
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-3 h-3 rounded-full" style="background-color: #5B9BD5;"></div>
                    <span class="text-sm md:text-base font-medium" style="color: #4D4D4D; font-family: Arial, sans-serif;">Total Items</span>
                </div>
                <div class="text-2xl md:text-3xl font-bold mb-1" id="total-products" style="color: #000000; font-family: Arial, sans-serif;">{{ total_items }}</div>

            </div>
            <div class="w-12 h-12 md:w-14 md:h-14 flex items-center justify-center rounded-md" style="background-color: #E8EEF4; border: 1px solid #C5C5C5;">
                <i class="bi bi-box-seam-fill text-xl md:text-2xl" style="color: #0066CC;"></i>
            </div>
        </div>
    </div>
    
    <div class="p-6 border rounded-lg" style="background-color: #FFFFFF; border-color: #C5C5C5; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div class="flex items-center justify-between">
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-3 h-3 rounded-full" style="background-color: #FFFF00;"></div>
                    <span class="text-sm font-medium" style="color: #4D4D4D; font-family: Arial, sans-serif;">Low Stock</span>
                </div>
                <div class="text-3xl font-bold mb-1" id="low-stock" style="color: #000000; font-family: Arial, sans-serif;">{{ low_stock_items }}</div>

            </div>
            <div class="w-14 h-14 flex items-center justify-center rounded-md" style="background-color: #E8EEF4; border: 1px solid #C5C5C5;">
                <i class="bi bi-exclamation-triangle-fill text-2xl" style="color: #FF9800;"></i>
            </div>
        </div>
    </div>
    
    <div class="p-6 border rounded-lg" style="background-color: #FFFFFF; border-color: #C5C5C5; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div class="flex items-center justify-between">
            <div>
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-3 h-3 rounded-full" style="background-color: #70AD47;"></div>
                    <span class="text-sm font-medium" style="color: #4D4D4D; font-family: Arial, sans-serif;">Active Products</span>
                </div>
                <div class="text-3xl font-bold mb-1" id="active-products" style="color: #000000; font-family: Arial, sans-serif;">{{ active_items }}</div>

            </div>
            <div class="w-14 h-14 flex items-center justify-center rounded-md" style="background-color: #E8EEF4; border: 1px solid #C5C5C5;">
                 <i class="bi bi-check-circle-fill text-2xl" style="color: #4CAF50;"></i>
             </div>
          </div>
        </div>
    </div>
</div>

<!-- Form Section -->
<div class="p-6 mb-8 rounded-lg border" style="background-color: #E8EEF4; border: 1px solid #C5C5C5; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    <!-- Item Master Header -->
    <div class="flex justify-between items-center mb-6">
        <div style="flex: 1;"></div>
        <div class="section-title section-title--line" style="flex: 0 0 auto;"><span>Item Master</span></div>
        <div style="flex: 1; display: flex; justify-content: flex-end;">
            <!-- Edit Button - Top Right Corner -->
            <button type="button" id="edit-btn" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                <i class="bi bi-pencil-square mr-2"></i>
                Edit Item
            </button>
        </div>
    </div>

    <!-- Two Column Form -->
    <form id="product-form">
        {% csrf_token %}
        
        <!-- Search Field -->
        <div class="mb-8 flex justify-center">
            <div class="flex flex-wrap items-center gap-2 w-full max-w-3xl px-2">
                <div class="relative w-full sm:w-80 mb-2 sm:mb-0">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="bi bi-search" style="color: #666666; font-size: 14px;"></i>
                    </div>
                    <input type="text" id="search-input" placeholder="Item Code / SKU/Barcode" 
                           style="width: 100%; padding: 8px 12px 8px 32px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
                </div>
                <button type="button" id="search-btn" class="w-full sm:w-auto" style="display: flex; align-items: center; background-color: #0066CC; color: white; border-radius: 4px; padding: 8px 12px; font-family: Arial, sans-serif; font-size: 14px; border: 1px solid #0055AA;">
                    <i class="bi bi-search mr-1" style="font-size: 14px;"></i>
                    <span style="font-weight: 500;">Search</span>
                </button>
                <button type="button" id="clear-search" class="w-full sm:w-auto" style="display: flex; align-items: center; background-color: #9BB4D0; color: #333333; border-radius: 4px; padding: 8px 12px; font-family: Arial, sans-serif; font-size: 14px; border: 1px solid #8AA3BF;">
                    <i class="bi bi-x mr-1" style="font-size: 14px;"></i>
                    <span style="font-weight: 500;">Clear</span>
                </button>
                <button type="button" id="reset-form" class="w-full sm:w-auto" style="display: flex; align-items: center; background-color: #C8D8E8; color: #333333; border-radius: 4px; padding: 8px 12px; font-family: Arial, sans-serif; font-size: 14px; border: 1px solid #B7C7D7;">
                    <i class="bi bi-arrow-repeat mr-1" style="font-size: 14px;"></i>
                    <span style="font-weight: 500;">Reset</span>
                </button>
            </div>
        </div>

        <!-- Six-line paired layout -->
        
        <!-- Line 1: Item Code + Description (Item Name) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
            <div>
                <label class="block text-sm font-medium text-black mb-1" style="font-family: 'Poppins', sans-serif; letter-spacing: 0.3px; font-weight: 600;">ðŸ“‹ Item Code <span style="color: #d32f2f; margin-left: 2px;">*</span></label>
                <input type="text" name="item_code" placeholder="Item code" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
            </div>
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Description (Item Name) <span style="color: #d32f2f; margin-left: 2px;">*</span></label>
                <input type="text" name="description" placeholder="Description / Item Name" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
        </div>

        <!-- Line 2: SKU + Barcode -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mt-4">
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">SKU <span style="color: #d32f2f; margin-left: 2px;">*</span></label>
                <input type="text" name="sku" placeholder="SKU" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Barcode</label>
                <input type="text" name="barcode" placeholder="Barcode" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
        </div>

        <!-- Line 3: Pack Description + Units (paired per request) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mt-4">
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Pack Description</label>
                <input type="text" name="pack_description" placeholder="Pack Description" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Units <span style="color: #d32f2f; margin-left: 2px;">*</span></label>
                <input type="text" name="units" placeholder="e.g., pcs, kg, ltr" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
        </div>
        <!-- Line 5: Stock Quantity + Stock Status (0 Disabled, 1 Enabled) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mt-4">
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Stock Quantity</label>
                <input type="number" name="stock_quantity" placeholder="Stock" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Stock Status</label>
                <input type="number" name="stock_status" placeholder="0 Disabled, 1 Enabled" min="0" max="1" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
        </div>

        <!-- Convert Units + Wrap (three fields in one line) -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-8 mt-4">
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">WDF</label>
                <input type="number" name="weight_division_factor" placeholder="Weight Division Factor" step="0.0001"
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div> 
            <div> 
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">OCQ</label> 
                <input type="number" name="outer_case_quantity" placeholder="Outer Case Quantity" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/> 
            </div> 
            <div> 
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Min Qty</label> 
                <input type="number" name="minimum_qty" placeholder="Minimum Quantity" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/> 
            </div> 
            <div> 
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Wrap</label> 
                <input type="text" name="wrap" placeholder="9900/10000" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/> 
            </div> 
        </div>
        
        <!-- Line 4: Cost + Converted Cost -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mt-4">
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Cost</label>
                <input type="number" name="cost_price" placeholder="0.00" step="0.01" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">Converted Cost</label>
                <input type="number" name="converted_cost" placeholder="Auto: cost Ã· weight_division_factor" step="0.01"
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #999999;"/>
            </div>
        </div>

        

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mt-4">
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">MRP</label>
                <input type="number" name="mrp" placeholder="MRP" step="0.01"
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
            <div>
                <label class="block mb-1" style="font-size: 14px; font-weight: 600; color: #333333; font-family: Arial, sans-serif;">S.Price (Final)</label>
                <input type="number" name="selling_price" placeholder="Sell.Price" step="0.01"
                       style="width: 100%; padding: 8px 12px; border: 1px solid #C5C5C5; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; color: #333333;"/>
            </div>
        </div>
        
        <!-- Save/Cancel Buttons -->
        <div class="mt-6 flex flex-wrap items-center gap-4 justify-center">
            <button type="button" id="save-btn" class="inline-flex items-center px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors" style="display: none;">
                <i class="bi bi-check-circle mr-2"></i>
                Save Changes
            </button>
            <button type="button" id="cancel-btn" class="inline-flex items-center px-6 py-3 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600 transition-colors" style="display: none;">
                <i class="bi bi-x-circle mr-2"></i>
                Cancel
            </button>
        </div>
        
        <!-- Hidden field to store current item ID -->
        <input type="hidden" id="current-item-id" value="">

        <!-- Central Locking System (CLS) -->
        <div class="mt-6 pt-6" style="border-top: 1px solid #E5E5E5;">
            <div class="section-title section-title--line"><span>Central Locking System (CLS)</span></div>
            <div class="flex flex-wrap items-center gap-4 md:gap-6 mt-4">
                <label class="flex items-center gap-3">
                    <input type="checkbox" name="price_locked" style="width: 16px; height: 16px; accent-color: #0066CC;">
                    <span style="font-size: 14px; font-weight: 500; color: #333333; font-family: Arial, sans-serif;">Price Lock</span>
                </label>
                <label class="flex items-center gap-3">
                    <input type="checkbox" name="status_locked" style="width: 16px; height: 16px; accent-color: #0066CC;">
                    <span style="font-size: 14px; font-weight: 500; color: #333333; font-family: Arial, sans-serif;">Status Lock</span>
                </label>
            </div>
        </div>
    </form>
</div>

<!-- Products panel intentionally omitted on Pasons dashboard -->

<!-- Inventory Table -->
<div class="outlet-panel rounded-lg border">
    <div class="p-4 md:p-6 border-b" style="border-bottom: 1px solid #E5E5E5;">
        <div class="section-title--line"><span>Outlet Availability</span></div>
        <p class="text-xs md:text-sm mt-1 section-subtitle">Shows outlets and prices for the selected product</p>
    </div>
    
    <div class="outlet-table-wrapper overflow-x-auto -mx-3 md:mx-0 mobile-card-table">
        <table class="min-w-full outlet-table" style="border-collapse: separate; border-spacing: 0;">
            <thead>
                <tr>
                    <th class="px-4 md:px-6 py-3 text-left text-[11px] md:text-xs" style="font-weight: 600; color: #555555; text-transform: uppercase; font-family: Arial, sans-serif;">Outlet</th>
                    <th class="px-4 md:px-6 py-3 text-left text-[11px] md:text-xs" style="font-weight: 600; color: #555555; text-transform: uppercase; font-family: Arial, sans-serif;">MRP</th>
                    <th class="px-4 md:px-6 py-3 text-left text-[11px] md:text-xs" style="font-weight: 600; color: #555555; text-transform: uppercase; font-family: Arial, sans-serif;">Stock</th>
                    <th class="px-4 md:px-6 py-3 text-left text-[11px] md:text-xs" style="font-weight: 600; color: #555555; text-transform: uppercase; font-family: Arial, sans-serif;">Selling Price</th>
                    <th class="px-4 md:px-6 py-3 text-left text-[11px] md:text-xs" style="font-weight: 600; color: #555555; text-transform: uppercase; font-family: Arial, sans-serif;">Stock Status</th>
                    <th class="px-4 md:px-6 py-3 text-left text-[11px] md:text-xs" style="font-weight: 600; color: #555555; text-transform: uppercase; font-family: Arial, sans-serif;">Cost</th>
                    <!-- Talabat Margin % (conditional) -->
                    <th id="margin-header" class="px-4 md:px-6 py-3 text-left text-[11px] md:text-xs" style="font-weight: 600; color: #555555; text-transform: uppercase; font-family: Arial, sans-serif; display: none;">Margin %</th>
                    <th class="px-4 md:px-6 py-3 text-left text-[11px] md:text-xs lock-cell" style="font-weight: 600; color: #555555; text-transform: uppercase; font-family: Arial, sans-serif; text-align:center;">BLS Price</th>
                    <th class="px-4 md:px-6 py-3 text-left text-[11px] md:text-xs lock-cell" style="font-weight: 600; color: #555555; text-transform: uppercase; font-family: Arial, sans-serif; text-align:center;">BLS Status</th>
                </tr>
            </thead>
            <tbody id="outlet-table">
                <!-- Products will be loaded dynamically -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% load static %}
{% block extra_js %}
<script>
  window.DASHBOARD_PLATFORM = '{{ active_nav }}';
</script>
<script src="{% static 'js/dashboard.js' %}"></script>

<!-- Client-side form validation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('product-form');
    if (!form) return;
    
    // Define validation rules
    const validationRules = {
        'item_code': { required: true, minLength: 1, pattern: null, message: 'Item Code is required' },
        'description': { required: true, minLength: 1, pattern: null, message: 'Description is required' },  // Fixed: Use 'description' instead of 'name'
        'sku': { required: true, minLength: 1, pattern: null, message: 'SKU is required' },
        'units': { required: true, minLength: 1, pattern: null, message: 'Units is required' },
        'selling_price': { required: false, minValue: 0, pattern: /^\d+(\.\d{1,2})?$/, message: 'Please enter a valid price (e.g., 10.50)' },
        'cost_price': { required: false, minValue: 0, pattern: /^\d+(\.\d{1,2})?$/, message: 'Please enter a valid cost (e.g., 5.00)' },
        'mrp': { required: false, minValue: 0, pattern: /^\d+(\.\d{1,2})?$/, message: 'Please enter a valid MRP' },
        'stock_quantity': { required: false, minValue: 0, pattern: /^\d+$/, message: 'Please enter a valid quantity' },
        'weight_division_factor': { required: false, minValue: 0, pattern: /^\d+(\.\d{1,4})?$/, message: 'WDF must be a positive number' },
        'outer_case_quantity': { required: false, minValue: 1, pattern: /^\d+$/, message: 'OCQ must be a positive integer (e.g., 4, 9)' },
        'minimum_qty': { required: false, minValue: 1, pattern: /^\d+$/, message: 'Minimum Qty must be a positive integer' }
    };
    
    // Add required attribute to required fields (asterisks already in HTML)
    Object.keys(validationRules).forEach(fieldName => {
        const field = form.querySelector(`[name="${fieldName}"]`);
        if (field && validationRules[fieldName].required) {
            field.setAttribute('required', 'required');
            field.setAttribute('data-required', 'true');
        }
    });
    
    // Validate individual field
    function validateField(field) {
        const fieldName = field.name;
        const rule = validationRules[fieldName];
        if (!rule) return true; // No rule, field is valid
        
        const value = field.value.trim();
        let errorMsg = '';
        let isValid = true;
        
        // Check required
        if (rule.required && !value) {
            errorMsg = rule.message || 'This field is required';
            isValid = false;
        }
        // Check minLength
        else if (rule.minLength && value && value.length < rule.minLength) {
            errorMsg = `Minimum ${rule.minLength} characters required`;
            isValid = false;
        }
        // Check pattern (for prices, quantities)
        else if (rule.pattern && value && !rule.pattern.test(value)) {
            errorMsg = rule.message || 'Invalid format';
            isValid = false;
        }
        // Check minValue (numeric fields)
        else if (rule.minValue !== undefined && value) {
            const numValue = parseFloat(value);
            if (isNaN(numValue) || numValue < rule.minValue) {
                errorMsg = `Value must be at least ${rule.minValue}`;
                isValid = false;
            }
        }
        
        // Update UI
        const container = field.closest('div');
        if (!isValid) {
            field.style.borderColor = '#d32f2f';
            field.style.boxShadow = '0 0 0 3px rgba(211, 47, 47, 0.1)';
            field.setAttribute('data-valid', 'false');
            field.title = errorMsg;
            // Show error message below field
            let errorEl = container.querySelector('.validation-error');
            if (!errorEl) {
                errorEl = document.createElement('div');
                errorEl.className = 'validation-error';
                errorEl.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 4px; display: none;';
                container.appendChild(errorEl);
            }
            errorEl.textContent = errorMsg;
            errorEl.style.display = 'block';
        } else {
            field.style.borderColor = '#C5C5C5';
            field.style.boxShadow = 'none';
            field.setAttribute('data-valid', 'true');
            field.title = '';
            const errorEl = container.querySelector('.validation-error');
            if (errorEl) errorEl.style.display = 'none';
        }
        
        return isValid;
    }
    
    // Attach validation listeners to all fields
    Object.keys(validationRules).forEach(fieldName => {
        const field = form.querySelector(`[name="${fieldName}"]`);
        if (field) {
            field.addEventListener('blur', function() {
                validateField(this);
            });
            field.addEventListener('change', function() {
                validateField(this);
            });
        }
    });
    
    // Validate form on save attempt (hook into saveProduct)
    const originalSaveProduct = window.saveProduct;
    if (originalSaveProduct) {
        window.saveProduct = function(itemCodeParam) {
            // Validate critical fields
            const criticalFields = ['item_code', 'description', 'sku', 'units'];  // Fixed: Use 'description' instead of 'name'
            let allValid = true;
            
            criticalFields.forEach(fieldName => {
                const field = form.querySelector(`[name="${fieldName}"]`);
                if (field && !validateField(field)) {
                    allValid = false;
                }
            });
            
            if (!allValid) {
                showModal('Please fill in all required fields correctly.', 'warning', 'Validation Error');
                return;
            }
            
            // Call original function
            return originalSaveProduct.call(this, itemCodeParam);
        };
    }
    
    // Add CSS for validation error styling
    const styleEl = document.createElement('style');
    styleEl.textContent = `
        input[data-required="true"]:invalid {
            border-color: #d32f2f;
        }
        input[data-valid="false"] {
            border-color: #d32f2f;
        }
        .validation-error {
            color: #d32f2f;
            font-size: 12px;
            margin-top: 4px;
        }
    `;
    document.head.appendChild(styleEl);
    
    // ===== INLINE EDITING FUNCTIONALITY =====
    
    let isEditMode = false;
    let originalValues = {};
    
    const editBtn = document.getElementById('edit-btn');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const currentItemIdField = document.getElementById('current-item-id');
    
    // Editable fields configuration - RESTRICTED: Only allow editing of basic item info and configuration
    const editableFields = [
        'sku', 'barcode', 'description', 'pack_description', 'units',  // Basic item information
        'weight_division_factor', 'outer_case_quantity', 'minimum_qty', 'wrap'  // Item configuration
        // EXCLUDED: stock_quantity, cost_price, mrp, selling_price, converted_cost (read-only)
        // NOTE: No talabat_margin for Pasons platform
    ];
    
    // Enable edit mode
    function enableEditMode() {
        if (!currentItemIdField.value) {
            showModal('Please search and select an item first', 'warning');
            return;
        }
        
        isEditMode = true;
        
        // Store original values
        originalValues = {};
        editableFields.forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field) {
                originalValues[fieldName] = field.value;
                field.style.backgroundColor = '#fff3cd'; // Light yellow background
                field.style.borderColor = '#ffc107'; // Yellow border
                field.removeAttribute('readonly');
                field.removeAttribute('disabled');
            }
        });
        
        // Update button visibility
        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-flex';
        cancelBtn.style.display = 'inline-flex';
        
        // Disable search while editing
        document.getElementById('search-input').disabled = true;
        document.getElementById('search-btn').disabled = true;
    }
    
    // Disable edit mode
    function disableEditMode() {
        isEditMode = false;
        
        // Reset field styles
        editableFields.forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field) {
                field.style.backgroundColor = '';
                field.style.borderColor = '#C5C5C5';
            }
        });
        
        // Update button visibility
        editBtn.style.display = 'inline-flex';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        
        // Re-enable search
        document.getElementById('search-input').disabled = false;
        document.getElementById('search-btn').disabled = false;
    }
    
    // Cancel editing
    function cancelEdit() {
        // Restore original values
        editableFields.forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field && originalValues[fieldName] !== undefined) {
                field.value = originalValues[fieldName];
            }
        });
        
        disableEditMode();
    }
    
    // Save changes
    async function saveChanges() {
        const itemId = currentItemIdField.value;
        if (!itemId) {
            showModal('No item selected', 'warning');
            return;
        }
        
        // Collect changes
        const updates = {};
        let hasChanges = false;
        
        editableFields.forEach(fieldName => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field && field.value !== originalValues[fieldName]) {
                updates[fieldName] = field.value;
                hasChanges = true;
            }
        });
        
        if (!hasChanges) {
            showModal('No changes to save', 'info');
            disableEditMode();
            return;
        }
        
        // Show loading
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split mr-2"></i>Saving...';
        saveBtn.disabled = true;
        
        try {
            const response = await fetch('/integration/api/item/inline-edit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    item_id: itemId,
                    updates: updates
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showModal(`Successfully updated: ${data.updated_fields.join(', ')}`, 'success');
                disableEditMode();
                
                // Refresh the item data
                const searchInput = document.getElementById('search-input');
                if (searchInput.value) {
                    searchItem(); // Refresh current item
                }
            } else {
                showModal(`Error: ${data.message}`, 'error');
                if (data.errors) {
                    console.error('Validation errors:', data.errors);
                }
            }
        } catch (error) {
            console.error('Save error:', error);
            showModal('Error saving changes. Please try again.', 'error');
        } finally {
            // Reset button
            saveBtn.innerHTML = '<i class="bi bi-check-circle mr-2"></i>Save Changes';
            saveBtn.disabled = false;
        }
    }
    
    // Enhanced search function
    async function searchItem() {
        const searchTerm = document.getElementById('search-input').value.trim();
        if (!searchTerm) {
            showModal('Please enter a search term', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/integration/api/item/search/?q=${encodeURIComponent(searchTerm)}&platform=pasons`);
            const data = await response.json();
            
            if (data.success && data.items.length > 0) {
                const item = data.items[0]; // Take first result
                
                // Populate form with item data
                currentItemIdField.value = item.id;
                
                const fieldMapping = {
                    'item_code': item.item_code,
                    'sku': item.sku,
                    'barcode': item.barcode,
                    'description': item.name,  // Fixed: Map to 'description' field
                    'pack_description': item.pack_description,
                    'units': item.units,
                    'stock_quantity': item.stock,
                    'weight_division_factor': item.weight_division_factor,
                    'outer_case_quantity': item.outer_case_quantity,
                    'minimum_qty': item.minimum_qty,
                    'wrap': item.wrap,
                    'cost_price': item.cost,
                    'mrp': item.mrp,
                    'selling_price': item.selling_price
                };
                
                Object.entries(fieldMapping).forEach(([fieldName, value]) => {
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        field.value = value || '';
                    }
                });
                
                // Show success message
                const searchBtn = document.getElementById('search-btn');
                const originalText = searchBtn.innerHTML;
                searchBtn.innerHTML = '<i class="bi bi-check mr-1"></i>Found!';
                searchBtn.style.backgroundColor = '#28a745';
                setTimeout(() => {
                    searchBtn.innerHTML = originalText;
                    searchBtn.style.backgroundColor = '#0066CC';
                }, 2000);
                
            } else {
                showModal('No items found matching your search', 'info');
                currentItemIdField.value = '';
            }
        } catch (error) {
            console.error('Search error:', error);
            showModal('Error searching for item. Please try again.', 'error');
        }
    }
    
    // Event listeners
    if (editBtn) editBtn.addEventListener('click', enableEditMode);
    if (saveBtn) saveBtn.addEventListener('click', saveChanges);
    if (cancelBtn) cancelBtn.addEventListener('click', cancelEdit);
    
    // Enhanced search button
    const searchBtn = document.getElementById('search-btn');
    if (searchBtn) {
        searchBtn.addEventListener('click', searchItem);
    }
    
    // Search on Enter key
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchItem();
            }
        });
    }
});
</script>

<!-- Beautiful Modal Alert System -->
<div id="customModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <div class="modal-icon" id="modalIcon">
                <i class="bi bi-info-circle"></i>
            </div>
            <h3 class="modal-title" id="modalTitle">Notification</h3>
            <button class="modal-close" onclick="closeModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="modal-message" id="modalMessage">Message content</p>
        </div>
        <div class="modal-footer">
            <button class="modal-btn modal-btn-primary" onclick="closeModal()">OK</button>
        </div>
    </div>
</div>

<style>
/* Modern Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 400px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
    transform: scale(0.7) translateY(-50px);
    transition: all 0.3s ease;
}

.modal-overlay.show .modal-container {
    transform: scale(1) translateY(0);
}

.modal-header {
    display: flex;
    align-items: center;
    padding: 20px 24px 16px;
    border-bottom: 1px solid #e5e7eb;
    position: relative;
}

.modal-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 18px;
}

.modal-icon.success {
    background: #dcfce7;
    color: #16a34a;
}

.modal-icon.error {
    background: #fef2f2;
    color: #dc2626;
}

.modal-icon.warning {
    background: #fefce8;
    color: #ca8a04;
}

.modal-icon.info {
    background: #dbeafe;
    color: #2563eb;
}

.modal-title {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
    margin: 0;
    flex: 1;
}

.modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border: none;
    background: #f3f4f6;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #6b7280;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: #e5e7eb;
    color: #374151;
}

.modal-body {
    padding: 16px 24px 24px;
}

.modal-message {
    font-size: 14px;
    line-height: 1.5;
    color: #4b5563;
    margin: 0;
}

.modal-footer {
    padding: 16px 24px 24px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.modal-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.modal-btn-primary {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
}

.modal-btn-primary:hover {
    background: #1d4ed8;
    border-color: #1d4ed8;
}

.modal-btn-secondary {
    background: #f3f4f6;
    color: #374151;
    border-color: #d1d5db;
}

.modal-btn-secondary:hover {
    background: #e5e7eb;
}

/* Success variant */
.modal-container.success .modal-header {
    border-bottom-color: #dcfce7;
}

.modal-container.success .modal-btn-primary {
    background: #16a34a;
    border-color: #16a34a;
}

.modal-container.success .modal-btn-primary:hover {
    background: #15803d;
    border-color: #15803d;
}

/* Error variant */
.modal-container.error .modal-header {
    border-bottom-color: #fef2f2;
}

.modal-container.error .modal-btn-primary {
    background: #dc2626;
    border-color: #dc2626;
}

.modal-container.error .modal-btn-primary:hover {
    background: #b91c1c;
    border-color: #b91c1c;
}

/* Warning variant */
.modal-container.warning .modal-header {
    border-bottom-color: #fefce8;
}

.modal-container.warning .modal-btn-primary {
    background: #ca8a04;
    border-color: #ca8a04;
}

.modal-container.warning .modal-btn-primary:hover {
    background: #a16207;
    border-color: #a16207;
}
</style>

<script>
// Beautiful Modal Functions
function showModal(message, type = 'info', title = null) {
    const modal = document.getElementById('customModal');
    const container = modal.querySelector('.modal-container');
    const icon = document.getElementById('modalIcon');
    const titleEl = document.getElementById('modalTitle');
    const messageEl = document.getElementById('modalMessage');
    
    // Set type-specific styling
    container.className = `modal-container ${type}`;
    icon.className = `modal-icon ${type}`;
    
    // Set icon based on type
    const icons = {
        success: 'bi-check-circle',
        error: 'bi-x-circle',
        warning: 'bi-exclamation-triangle',
        info: 'bi-info-circle'
    };
    
    const titles = {
        success: 'Success',
        error: 'Error',
        warning: 'Warning',
        info: 'Information'
    };
    
    icon.innerHTML = `<i class="bi ${icons[type] || icons.info}"></i>`;
    titleEl.textContent = title || titles[type] || titles.info;
    messageEl.textContent = message;
    
    // Show modal
    modal.classList.add('show');
    
    // Auto-close success messages after 3 seconds
    if (type === 'success') {
        setTimeout(() => {
            closeModal();
        }, 3000);
    }
}

function closeModal() {
    const modal = document.getElementById('customModal');
    modal.classList.remove('show');
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('customModal');
    if (e.target === modal) {
        closeModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}