{% extends 'base.html' %}
{% load static %}

{% block title %}Product Update{% endblock %}

{% block extra_head %}
<style>
.bulk-card-subtitle {
    color: #007bff !important;
}

#csvSampleBtn {
    background-color: #f8f9fa !important;
    border-color: #dee2e6 !important;
    color: #6c757d !important;
}

#csvSampleBtn:hover {
    background-color: #e9ecef !important;
    border-color: #adb5bd !important;
    color: #495057 !important;
}

/* Preview Button Styles */
.bulk-btn-primary {
    background-color: #007bff;
    color: white;
    border: 1px solid #007bff;
}

.bulk-btn-primary:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    overflow: auto;
}

.modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    padding: 0;
    border: none;
    border-radius: 12px;
    width: 95%;
    max-width: 1200px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
}

.close:hover {
    color: #f1f1f1;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    background-color: #f8f9fa;
    padding: 15px 20px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    border-top: 1px solid #dee2e6;
}

/* Preview Summary Styles */
.preview-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.stat-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
    min-width: 150px;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 5px;
}

.stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: 600;
    color: #495057;
}

.preview-errors, .preview-warnings {
    margin: 15px 0;
    padding: 15px;
    border-radius: 8px;
}

.preview-errors {
    background-color: #f8d7da;
    border-left: 4px solid #dc3545;
}

.preview-warnings {
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
}

.preview-errors h4, .preview-warnings h4 {
    margin: 0 0 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.preview-errors ul, .preview-warnings ul {
    margin: 0;
    padding-left: 20px;
}

/* Preview Table Styles */
.preview-table-container {
    overflow-x: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.preview-table th {
    background-color: #f8f9fa;
    padding: 12px 8px;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    position: sticky;
    top: 0;
    z-index: 10;
}

.preview-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #dee2e6;
    vertical-align: top;
}

.preview-table tr:hover {
    background-color: #f8f9fa;
}

/* Status Badge Styles */
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
}

.status-valid {
    background-color: #d4edda;
    color: #155724;
}

.status-warning {
    background-color: #fff3cd;
    color: #856404;
}

.status-error {
    background-color: #f8d7da;
    color: #721c24;
}

/* Row Status Styles */
.preview-table tr.status-error {
    background-color: #fdf2f2;
}

.preview-table tr.status-warning {
    background-color: #fffbf0;
}

.preview-table tr.status-valid {
    background-color: #f0f9f0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .modal-content {
        width: 98%;
        margin: 1% auto;
    }

    .preview-stats {
        flex-direction: column;
    }

    .stat-item {
        min-width: auto;
    }

    .modal-footer {
        flex-direction: column;
    }

    .modal-footer .bulk-btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="bulk-operations-container">
    <div class="bulk-row">
        <div class="bulk-col-12">
            <div class="bulk-card">
                <div class="bulk-card-header">
                    <h1 class="bulk-card-title">✏️ Product Update</h1>
                    <p class="bulk-card-subtitle">Update product Units, MRP, and Stock via CSV upload</p>
                </div>
                <div class="bulk-card-body">
                    <form method="post" enctype="multipart/form-data" id="productUpdateForm">
                        {% csrf_token %}

                        <div class="bulk-row">
                            <div class="bulk-col-6">
                                <!-- Platform Selection -->
                                <div class="bulk-form-group">
                                    <label for="platform" class="bulk-form-label">
                                        <i class="bx bx-store"></i> Select Platform
                                    </label>
                                    <select class="bulk-form-control" id="platform" name="platform" required>
                                        <option value="">Select Platform</option>
                                        <option value="pasons">Pasons Ecommerce</option>
                                        <option value="talabat">Talabat Platform</option>
                                    </select>
                                </div>
                            </div>

                            <div class="bulk-col-6">
                                <!-- Outlet Selection -->
                                <div class="bulk-form-group">
                                    <label for="outlet" class="bulk-form-label">
                                        <i class="bx bx-building"></i> Select Outlet
                                    </label>
                                    <select id="outlet" name="outlet" class="bulk-form-control" required>
                                        <option value="">Select a platform first</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="bulk-row">
                            <div class="bulk-col-12">
                                <!-- Update Type Selection -->
                                <div class="bulk-form-group">
                                    <label for="update_type" class="bulk-form-label">
                                        <i class="bx bx-edit"></i> Update Type
                                    </label>
                                    <select class="bulk-form-control" id="update_type" name="update_type" required>
                                        <option value="all" selected>All (MRP + Cost + Stock)</option>
                                        <option value="mrp_only">MRP Only</option>
                                        <option value="cost_only">Cost Only</option>
                                        <option value="stock_only">Stock Only</option>
                                        <option value="mrp_cost">MRP + Cost</option>
                                        <option value="mrp_stock">MRP + Stock</option>
                                        <option value="cost_stock">Cost + Stock</option>
                                    </select>
                                    <small class="bulk-form-help">
                                        <strong>CSV Headers:</strong>
                                        <span id="requiredHeadersHelp">item_code, units + (mrp, cost, stock based on selection)</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- File Upload -->
                        <div class="bulk-form-group">
                            <label for="csvFile" class="bulk-form-label">
                                <i class="bx bx-file"></i> Choose CSV File (item_code, units, mrp, cost, stock)
                            </label>
                            <div class="file-upload-container">
                                <div class="file-upload-area" id="fileUploadArea">
                                    <input type="file" id="csvFile" name="csv_file" accept=".csv"
                                        class="file-input-hidden" required>
                                    <div class="upload-content">
                                        <i class="bx bx-cloud-upload upload-icon"></i>
                                        <div class="upload-text">Browse Files</div>
                                        <div class="upload-subtext">or drag and drop your CSV file here</div>
                                        <div class="upload-format">Supported format: .csv (Max size: 10MB)</div>
                                    </div>
                                </div>
                                <div id="selectedFile" class="selected-file-display" style="display: none;">
                                    <div class="file-preview">
                                        <div class="file-icon">
                                            <i class="bx bx-file-blank"></i>
                                        </div>
                                        <div class="file-details">
                                            <div class="file-name" id="fileName"></div>
                                            <div class="file-size" id="fileSize"></div>
                                            <div class="file-status">
                                                <i class="bx bx-check-circle"></i>
                                                <span>Ready to upload</span>
                                            </div>
                                        </div>
                                        <button type="button" class="remove-file-btn" id="removeFile">
                                            <i class="bx bx-trash"></i>
                                            <span>Delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="bulk-form-actions">
                            <button type="button" id="csvSampleBtn" class="bulk-btn bulk-btn-outline">
                                <i class="bx bx-download"></i> Download Sample CSV
                            </button>
                            <button type="button" class="bulk-btn bulk-btn-outline" onclick="resetForm()">
                                <i class="bx bx-reset"></i> Reset
                            </button>
                            <button type="button" class="bulk-btn bulk-btn-primary" id="previewBtn">
                                <i class="bx bx-show"></i> Preview CSV
                            </button>
                            <button type="submit" class="bulk-btn bulk-btn-success" id="updateBtn">
                                <i class="bx bx-upload"></i> Update Products
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="bx bx-show"></i> CSV Preview</h3>
            <span class="close" onclick="closePreviewModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="previewSummary" class="preview-summary"></div>
            <div id="previewTable" class="preview-table-container"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="bulk-btn bulk-btn-outline" onclick="closePreviewModal()">
                <i class="bx bx-x"></i>
                Cancel
            </button>
            <button type="button" class="bulk-btn bulk-btn-success" id="confirmUpdateBtn">
                <i class="bx bx-check"></i>
                Update Products
            </button>
        </div>
    </div>
</div>

<script>
    // File upload handling
    const fileInput = document.getElementById('csvFile');
    const uploadArea = document.querySelector('.file-upload-area');
    const selectedFile = document.getElementById('selectedFile');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFileBtn = document.getElementById('removeFile');

    // File input change event
    fileInput.addEventListener('change', handleFileSelect);

    // Click to upload - with debounce protection and validation
    let isClicking = false;
    uploadArea.addEventListener('click', (e) => {
        if (isClicking) return;

        // Check if platform and outlet are selected before allowing file upload
        const platform = document.getElementById('platform').value;
        const outlet = document.getElementById('outlet').value;

        if (!platform || !outlet) {
            showModal({ title: 'Selection Required', message: 'Please select items in the list.', type: 'warning' });
            e.preventDefault();
            e.stopPropagation();
            return;
        }

        isClicking = true;

        e.preventDefault();
        e.stopPropagation();

        fileInput.click();

        // Reset flag after a short delay
        setTimeout(() => {
            isClicking = false;
        }, 500);
    });

    // Clear file when outlet selection changes
    document.getElementById('outlet').addEventListener('change', function () {
        // Clear any selected file when outlet changes
        if (fileInput.files.length > 0) {
            removeFile();
        }
    });

    // Drag and drop events
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    uploadArea.addEventListener('drop', handleDrop);

    // Remove file button
    removeFileBtn.addEventListener('click', removeFile);

    // File size formatter
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            // Check if platform and outlet are selected
            const platform = document.getElementById('platform').value;
            const outlet = document.getElementById('outlet').value;

            if (!platform || !outlet) {
                showModal({ title: 'Selection Required', message: 'Please select items in the list.', type: 'warning' });
                fileInput.value = '';
                return;
            }

            // Check file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showModal({ title: 'File Too Large', message: 'File size must be less than 10MB.', type: 'warning' });
                fileInput.value = '';
                return;
            }
            displayFileInfo(file);
        }
    }

    function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');

        // Check if platform and outlet are selected before allowing file drop
        const platform = document.getElementById('platform').value;
        const outlet = document.getElementById('outlet').value;

        if (!platform || !outlet) {
            showModal({ title: 'Selection Required', message: 'Please select items in the list.', type: 'warning' });
            return;
        }

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    showModal({ title: 'File Too Large', message: 'File size must be less than 10MB.', type: 'warning' });
                    return;
                }
                fileInput.files = files;
                displayFileInfo(file);
            } else {
                showModal({ title: 'CSV Required', message: 'Please select a CSV file.', type: 'warning' });
            }
        }
    }

    function displayFileInfo(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        selectedFile.style.display = 'block';
        uploadArea.style.display = 'none';
    }

    function removeFile() {
        fileInput.value = '';
        selectedFile.style.display = 'none';
        uploadArea.style.display = 'block';
    }

    function resetForm() {
        document.getElementById('productUpdateForm').reset();
        removeFile();
    }

    // Update type change handler - update help text and sample CSV headers
    document.getElementById('update_type').addEventListener('change', function() {
        const updateType = this.value;
        const helpSpan = document.getElementById('requiredHeadersHelp');
        const fileLabel = document.querySelector('label[for="csvFile"]');
        
        let headers = 'item_code, units';
        let labelText = 'item_code, units';
        
        switch(updateType) {
            case 'mrp_only':
                headers = 'item_code, units, mrp';
                labelText = 'item_code, units, mrp';
                break;
            case 'cost_only':
                headers = 'item_code, units, cost';
                labelText = 'item_code, units, cost';
                break;
            case 'stock_only':
                headers = 'item_code, units, stock';
                labelText = 'item_code, units, stock';
                break;
            case 'mrp_cost':
                headers = 'item_code, units, mrp, cost';
                labelText = 'item_code, units, mrp, cost';
                break;
            case 'mrp_stock':
                headers = 'item_code, units, mrp, stock';
                labelText = 'item_code, units, mrp, stock';
                break;
            case 'cost_stock':
                headers = 'item_code, units, cost, stock';
                labelText = 'item_code, units, cost, stock';
                break;
            case 'all':
            default:
                headers = 'item_code, units, mrp, cost, stock';
                labelText = 'item_code, units, mrp, cost, stock';
                break;
        }
        
        helpSpan.textContent = headers;
        fileLabel.innerHTML = `<i class="bx bx-file"></i> Choose CSV File (${labelText})`;
    });

    // Platform-based outlet filtering
    document.getElementById('platform').addEventListener('change', function () {
        const platform = this.value;
        const outletSelect = document.getElementById('outlet');

        // Clear any selected file when platform changes
        if (fileInput.files.length > 0) {
            removeFile();
        }

        if (platform) {
            // Clear current outlet options and show loading
            outletSelect.innerHTML = '<option value="">Loading outlets...</option>';

            // Fetch outlets for selected platform
            fetch(`/integration/api/outlets-by-platform/?platform=${platform}`)
                .then(response => response.json())
                .then(data => {
                    outletSelect.innerHTML = '<option value="">Choose Outlet...</option>';

                    data.outlets.forEach(outlet => {
                        const option = document.createElement('option');
                        option.value = outlet.id;
                        option.textContent = `${outlet.name} - ${outlet.location}`;
                        outletSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching outlets:', error);
                    outletSelect.innerHTML = '<option value="">Error loading outlets</option>';
                });
        } else {
            // Clear outlets when no platform is selected
            outletSelect.innerHTML = '<option value="">Select a platform first</option>';
        }
    });



    // Form validation
    document.getElementById('productUpdateForm').addEventListener('submit', function (e) {
        const platform = document.getElementById('platform').value;
        const outlet = document.getElementById('outlet').value;

        const file = document.getElementById('csvFile').files[0];

        if (!platform) {
            e.preventDefault();
            showModal({ title: 'Platform Required', message: 'Please select a platform.', type: 'warning' });
            return;
        }

        if (!outlet) {
            e.preventDefault();
            showModal({ title: 'Outlet Required', message: 'Please select an outlet.', type: 'warning' });
            return;
        }



        if (!file) {
            e.preventDefault();
            showModal({ title: 'CSV Required', message: 'Please select a CSV file.', type: 'warning' });
            return;
        }

        // Show loading state
        const updateBtn = document.getElementById('updateBtn');
        updateBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Uploading...';
        updateBtn.disabled = true;
    });

    // CSV Sample Download - dynamic based on update type
    document.getElementById('csvSampleBtn').addEventListener('click', function () {
        const updateType = document.getElementById('update_type').value;
        let csvContent = '';
        let filename = 'product_update_sample.csv';
        
        // Generate CSV based on update type
        switch(updateType) {
            case 'mrp_only':
                csvContent = 'item_code,units,mrp\n9900127,KGS,11.95\n9900186,KGS,8.99\n100012,PCS,15.00';
                filename = 'mrp_update_sample.csv';
                break;
            case 'cost_only':
                csvContent = 'item_code,units,cost\n9900127,KGS,6.00\n9900186,KGS,4.50\n100012,PCS,10.00';
                filename = 'cost_update_sample.csv';
                break;
            case 'stock_only':
                csvContent = 'item_code,units,stock\n9900127,KGS,50\n9900186,KGS,100\n100012,PCS,200';
                filename = 'stock_update_sample.csv';
                break;
            case 'mrp_cost':
                csvContent = 'item_code,units,mrp,cost\n9900127,KGS,11.95,6.00\n9900186,KGS,8.99,4.50\n100012,PCS,15.00,10.00';
                filename = 'mrp_cost_update_sample.csv';
                break;
            case 'mrp_stock':
                csvContent = 'item_code,units,mrp,stock\n9900127,KGS,11.95,50\n9900186,KGS,8.99,100\n100012,PCS,15.00,200';
                filename = 'mrp_stock_update_sample.csv';
                break;
            case 'cost_stock':
                csvContent = 'item_code,units,cost,stock\n9900127,KGS,6.00,50\n9900186,KGS,4.50,100\n100012,PCS,10.00,200';
                filename = 'cost_stock_update_sample.csv';
                break;
            case 'all':
            default:
                csvContent = 'item_code,units,mrp,cost,stock\n9900127,KGS,11.95,6.00,50\n9900186,KGS,8.99,4.50,100\n100012,PCS,15.00,10.00,200';
                filename = 'product_update_sample.csv';
                break;
        }
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    // Preview button event handler
    document.getElementById('previewBtn').addEventListener('click', function() {
        const platform = document.getElementById('platform').value;
        const outlet = document.getElementById('outlet').value;
        const file = document.getElementById('csvFile').files[0];
        
        if (!platform) {
            showModal({ title: 'Platform Required', message: 'Please select a platform.', type: 'warning' });
            return;
        }
        
        if (!outlet) {
            showModal({ title: 'Outlet Required', message: 'Please select an outlet.', type: 'warning' });
            return;
        }
        
        if (!file) {
            showModal({ title: 'CSV Required', message: 'Please select a CSV file.', type: 'warning' });
            return;
        }
        
        // Show loading state
        const previewBtn = document.getElementById('previewBtn');
        previewBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Loading Preview...';
        previewBtn.disabled = true;
        
        // Create FormData for preview API
        const formData = new FormData();
        formData.append('platform', platform);
        formData.append('csv_file', file);
        formData.append('operation_type', 'product_update');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Call preview API
        fetch('/integration/api/preview-csv/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPreviewModal(data);
            } else {
                showModal({ title: 'Error', message: 'Error: ' + data.message, type: 'error' });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showModal({ title: 'Processing Error', message: 'Error processing CSV file.', type: 'error' });
        })
        .finally(() => {
            // Reset button state
            previewBtn.innerHTML = '<i class="bx bx-show"></i> Preview CSV';
            previewBtn.disabled = false;
        });
    });
    
    // Confirm update button event handler
     document.getElementById('confirmUpdateBtn').addEventListener('click', function() {
         closePreviewModal();
         document.getElementById('updateBtn').click();
     });

    // Show preview modal function
    window.showPreviewModal = function(data) {
        const modal = document.getElementById('previewModal');
        const summaryDiv = document.getElementById('previewSummary');
        const tableDiv = document.getElementById('previewTable');
        
        // Get selected outlet name
        const outletSelect = document.getElementById('outlet');
        const outletName = outletSelect.options[outletSelect.selectedIndex]?.text || 'Unknown';
        
        // Create summary
        let summaryHtml = `
            <div class="preview-stats">
                <div class="stat-item">
                    <span class="stat-label">Total Rows:</span>
                    <span class="stat-value">${data.total_rows}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Preview Rows:</span>
                    <span class="stat-value">${data.preview_rows}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Platform:</span>
                    <span class="stat-value">${data.platform}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Outlet:</span>
                    <span class="stat-value">${outletName}</span>
                </div>
            </div>
        `;
        
        if (data.errors && data.errors.length > 0) {
            summaryHtml += `
                <div class="preview-errors">
                    <h4><i class="bx bx-error"></i> Errors:</h4>
                    <ul>
                        ${data.errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        if (data.warnings && data.warnings.length > 0) {
            summaryHtml += `
                <div class="preview-warnings">
                    <h4><i class="bx bx-warning"></i> Warnings:</h4>
                    <ul>
                        ${data.warnings.map(warning => `<li>${warning}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        summaryDiv.innerHTML = summaryHtml;
        
        // Create table for product update preview
        let tableHtml = `
            <table class="preview-table">
                <thead>
                    <tr>
                        <th>Row</th>
                        <th>Status</th>
                        <th>Item Code</th>
                        <th>Units</th>
                        <th>MRP</th>
                        <th>Cost</th>
                        <th>Stock</th>
                        <th>Errors</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        if (data.preview_data && data.preview_data.length > 0) {
            data.preview_data.forEach(row => {
                const statusClass = `status-${row.status}`;
                const statusBadge = `<span class="status-badge ${statusClass}">${row.status}</span>`;
                const errors = row.errors && row.errors.length > 0 ? row.errors.join(', ') : '';
                
                tableHtml += `
                    <tr class="${statusClass}">
                        <td>${row.row_number}</td>
                        <td>${statusBadge}</td>
                        <td>${row.data.item_code || ''}</td>
                        <td>${row.data.units || ''}</td>
                        <td>${row.data.mrp || ''}</td>
                        <td>${row.data.cost || ''}</td>
                        <td>${row.data.stock || ''}</td>
                        <td>${errors}</td>
                    </tr>
                `;
            });
        }
        
        tableHtml += `
                </tbody>
            </table>
        `;
        
        tableDiv.innerHTML = tableHtml;
        
        // Show modal
        modal.style.display = 'block';
    };
    
    window.closePreviewModal = function() {
        document.getElementById('previewModal').style.display = 'none';
    };
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('previewModal');
        if (event.target === modal) {
            closePreviewModal();
        }
    });
</script>
{% endblock %}