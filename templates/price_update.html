{% extends 'base.html' %}
{% load static %}

{% block title %}Price Update{% endblock %}

{% block content %}
<div class="bulk-operations-container">
    <div class="bulk-card">
        <div class="bulk-card-header" style="background: #FFFFFF; border-bottom: 1px solid #E5E5E5;">
            <h3 class="bulk-card-title" style="color: #333333;">
                <i class="bx bx-dollar-circle" style="color: #0066CC;"></i>
                Price Update
            </h3>
            <p class="bulk-card-subtitle" style="color: #666666;">Update product prices via CSV upload for Pasons and Talabat platforms</p>
        </div>
        <div class="bulk-card-body">
                    <form method="post" enctype="multipart/form-data" id="priceUpdateForm">
                        {% csrf_token %}
                        
                        <!-- Platform Selection -->
                        <div class="bulk-row">
                            <div class="bulk-col">
                                <div class="bulk-form-group">
                                    <label for="platform" class="bulk-form-label">Platform <span class="required">*</span></label>
                                    <select class="bulk-form-control" id="platform" name="platform" required>
                                        <option value="">Select Platform</option>
                                        <option value="pasons">Pasons Ecommerce</option>
                                        <option value="talabat">Talabat Platform</option>
                                    </select>
                                </div>
                            </div>
                            <div class="bulk-col">
                                <div class="bulk-form-group">
                                    <label for="outlet" class="bulk-form-label">Outlet <span class="required">*</span></label>
                                    <select class="bulk-form-control" id="outlet" name="outlet" required>
                                        <option value="">Select a platform first</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Price Update Type -->
                        <div class="bulk-row">
                            <div class="bulk-col">
                                <div class="bulk-form-group">
                                    <label for="price_type" class="bulk-form-label">Price Update Type <span class="required">*</span></label>
                                    <select class="bulk-form-control" id="price_type" name="price_type" required>
                                        <option value="">Select Price Type</option>
                                        <option value="cost">Cost Only</option>
                                        <option value="mrp">MRP Only</option>
                                        <option value="cost_mrp">Cost & MRP (Both)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- CSV File Upload -->
                        <div class="bulk-form-group">
                            <label for="csv_file" class="bulk-form-label">CSV File <span class="required">*</span></label>
                            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                Required format: <code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace;">item_code, units, cost/mrp (based on type)</code>
                            </div>
                            <div class="file-upload-area" id="uploadArea">
                                <div class="upload-content">
                                    <i class="bx bx-cloud-upload upload-icon"></i>
                                    <div class="upload-text">Drag & Drop CSV File Here</div>
                                    <div class="upload-subtext">or click to browse</div>
                                    <input type="file" id="csv_file" name="csv_file" accept=".csv" required class="file-input-hidden">
                                </div>
                                <div class="selected-file" id="fileInfo" style="display: none;">
                                    <div class="file-info">
                                        <i class="bx bx-file"></i>
                                        <div>
                                            <div class="file-name" id="fileName"></div>
                                            <div class="file-size" id="fileSize"></div>
                                        </div>
                                    </div>
                                    <button type="button" class="remove-file" id="removeFile">
                                        <i class="bx bx-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 20px; padding-top: 20px; border-top: 1px solid #E5E5E5;">
                            <a href="#" class="sample-csv-link" id="downloadSample" style="padding: 10px 20px; background: #F5F5F5; color: #333333; border: 1px solid #C5C5C5; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 500;">
                                <i class="bx bx-download"></i>
                                Download Sample CSV
                            </a>
                            <button type="button" class="bulk-btn bulk-btn-warning" id="previewBtn" style="padding: 10px 20px; background-color: #FF9800; color: #FFFFFF; border: none; border-radius: 6px; display: inline-flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">
                                <i class="bx bx-show"></i>
                                Preview CSV
                            </button>
                            <button type="submit" class="bulk-btn bulk-btn-success" id="submitBtn" style="padding: 10px 20px; background-color: #0066CC; color: #FFFFFF; border: none; border-radius: 6px; display: inline-flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">
                                <i class="bx bx-upload"></i>
                                Update Prices
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


</div>

{% endblock %}




{% block extra_js %}
<script>
// File upload handling
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('csv_file');
const fileInfo = document.getElementById('fileInfo');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const removeFileBtn = document.getElementById('removeFile');
const uploadContent = uploadArea.querySelector('.upload-content');
const priceTypeSelect = document.getElementById('price_type');
const headersList = document.getElementById('headersList');

// Helper function to format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Price type change handler
priceTypeSelect.addEventListener('change', function() {
    const sellingHeader = headersList.querySelector('.selling-price-header');
    const costHeader = headersList.querySelector('.cost-header');
    const mrpHeader = headersList.querySelector('.mrp-header');
    
    // Hide all headers first
    sellingHeader.style.display = 'none';
    costHeader.style.display = 'none';
    mrpHeader.style.display = 'none';
    
    // Show relevant headers based on selection
    switch(this.value) {
        case 'selling_price':
            sellingHeader.style.display = 'inline-block';
            break;
        case 'cost':
            costHeader.style.display = 'inline-block';
            break;
        case 'mrp':
            mrpHeader.style.display = 'inline-block';
            break;
        case 'all_prices':
            sellingHeader.style.display = 'inline-block';
            costHeader.style.display = 'inline-block';
            mrpHeader.style.display = 'inline-block';
            break;
    }
});

// Click to upload
uploadArea.addEventListener('click', () => {
    if (!fileInfo.style.display || fileInfo.style.display === 'none') {
        fileInput.click();
    }
});

// Drag and drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('bulk-upload-dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('bulk-upload-dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('bulk-upload-dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

// File input change
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

// Handle file selection
function handleFileSelect(file) {
    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            showModal({ title: 'CSV Required', message: 'Please select a CSV file.', type: 'warning' });
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) { // 5MB limit
            showModal({ title: 'File Too Large', message: 'File size must be less than 5MB.', type: 'warning' });
        return;
    }
    
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    uploadContent.style.display = 'none';
    fileInfo.style.display = 'flex';
    
    // Set the file to the input
    const dt = new DataTransfer();
    dt.items.add(file);
    fileInput.files = dt.files;
}

// Remove file
removeFileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    fileInput.value = '';
    uploadContent.style.display = 'block';
    fileInfo.style.display = 'none';
});

// CSV Preview functionality
function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const rows = [];
    
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
            rows.push(lines[i].split(',').map(cell => cell.trim()));
        }
    }
    
    return { headers, rows };
}

function showCSVPreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvText = e.target.result;
        const { headers, rows } = parseCSV(csvText);
        const priceType = priceTypeSelect.value;
        const platform = document.getElementById('platform').value;
        const outlet = document.getElementById('outlet').options[document.getElementById('outlet').selectedIndex].text;
        
        // Validate headers
        const requiredHeaders = ['item_code', 'units'];
        const expectedPriceHeaders = {
            'selling_price': ['selling_price'],
            'cost': ['cost'],
            'mrp': ['mrp'],
            'all_prices': ['selling_price', 'cost', 'mrp']
        };
        
        const missingRequired = requiredHeaders.filter(h => !headers.includes(h));
        const priceHeaders = expectedPriceHeaders[priceType] || [];
        const missingPrice = priceHeaders.filter(h => !headers.includes(h));
        
        let validationErrors = [];
        if (missingRequired.length > 0) {
            validationErrors.push(`Missing required columns: ${missingRequired.join(', ')}`);
        }
        if (missingPrice.length > 0) {
            validationErrors.push(`Missing price column(s): ${missingPrice.join(', ')}`);
        }
        
        // Create professional preview modal with overlay
        const overlay = document.createElement('div');
        overlay.id = 'csv-preview-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
        overlay.style.zIndex = '9998';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        
        const previewModal = document.createElement('div');
        previewModal.id = 'csv-preview-modal';
        previewModal.style.position = 'fixed';
        previewModal.style.top = '50%';
        previewModal.style.left = '50%';
        previewModal.style.transform = 'translate(-50%, -50%)';
        previewModal.style.backgroundColor = '#fff';
        previewModal.style.borderRadius = '12px';
        previewModal.style.boxShadow = '0 10px 40px rgba(0,0,0,0.25)';
        previewModal.style.zIndex = '9999';
        previewModal.style.width = '95%';
        previewModal.style.maxWidth = '1000px';
        previewModal.style.maxHeight = '90vh';
        previewModal.style.display = 'flex';
        previewModal.style.flexDirection = 'column';
        previewModal.style.overflow = 'hidden';
        
        // Professional Header
        const modalHeader = document.createElement('div');
        modalHeader.style.background = 'linear-gradient(135deg, #0066CC 0%, #0052A3 100%)';
        modalHeader.style.padding = '28px';
        modalHeader.style.color = '#fff';
        modalHeader.style.display = 'flex';
        modalHeader.style.justifyContent = 'space-between';
        modalHeader.style.alignItems = 'center';
        modalHeader.style.fontFamily = 'Arial, sans-serif';
        
        const headerTitle = document.createElement('div');
        headerTitle.innerHTML = '<i style="font-size: 24px; margin-right: 12px;">üìã</i><span style="font-size: 18px; font-weight: 600;">CSV Preview & Validation</span>';
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '√ó';
        closeBtn.style.border = 'none';
        closeBtn.style.background = 'rgba(255,255,255,0.1)';
        closeBtn.style.color = '#fff';
        closeBtn.style.fontSize = '32px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.padding = '0 8px';
        closeBtn.style.borderRadius = '6px';
        closeBtn.style.transition = 'all 0.2s';
        closeBtn.addEventListener('mouseover', () => { closeBtn.style.background = 'rgba(255,255,255,0.2)'; });
        closeBtn.addEventListener('mouseout', () => { closeBtn.style.background = 'rgba(255,255,255,0.1)'; });
        
        modalHeader.appendChild(headerTitle);
        modalHeader.appendChild(closeBtn);
        
        // Modal Body
        const modalBody = document.createElement('div');
        modalBody.style.padding = '24px';
        modalBody.style.overflowY = 'auto';
        modalBody.style.flex = '1';
        modalBody.style.backgroundColor = '#F8F9FA';
        
        let bodyHTML = '';
        
        // Summary Stats Cards
        bodyHTML += '<div class="summary-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">';
        
        bodyHTML += `
            <div style="background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%); border: 1px solid #DEE2E6; border-radius: 8px; padding: 14px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: #0066CC; margin-bottom: 4px;">${rows.length}</div>
                <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Items to Update</div>
            </div>
            <div style="background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%); border: 1px solid #DEE2E6; border-radius: 8px; padding: 14px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: #0066CC; margin-bottom: 4px;">${platform.toUpperCase()}</div>
                <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Platform</div>
            </div>
            <div style="background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%); border: 1px solid #DEE2E6; border-radius: 8px; padding: 14px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: #0066CC; margin-bottom: 4px;">${headers.length}</div>
                <div style="font-size: 11px; color: #666; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Columns</div>
            </div>
        `;
        
        bodyHTML += '</div>';
        
        // Outlet Info Card
        bodyHTML += `
            <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 12px; margin-bottom: 20px; font-family: Arial; font-size: 13px; color: #0c5460;">
                <strong>üìç Outlet:</strong> ${outlet}
            </div>
        `;
        
        // Validation Errors Panel
        if (validationErrors.length > 0) {
            bodyHTML += `
                <div style="background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%); border: 2px solid #EF5350; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <div style="width: 36px; height: 36px; background: #C62828; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">‚úï</div>
                        <div>
                            <div style="font-size: 14px; font-weight: 700; color: #C62828;">Validation Errors Found (${validationErrors.length})</div>
                            <div style="font-size: 11px; color: #C62828; margin-top: 2px;">These issues must be fixed before upload</div>
                        </div>
                    </div>
                    <div style="background: white; border-radius: 6px; padding: 12px;">
                        <ul style="margin: 0; padding-left: 20px;">
            `;
            validationErrors.forEach(err => {
                bodyHTML += `<li style="font-size: 12px; color: #666; margin-bottom: 6px;">${err}</li>`;
            });
            bodyHTML += `
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // Table Preview
        bodyHTML += '<div style="background: white; border: 1px solid #E0E0E0; border-radius: 6px; overflow: hidden; margin-bottom: 16px;">';
        bodyHTML += '<div style="max-height: 400px; overflow-y: auto;">';
        bodyHTML += '<table style="width: 100%; border-collapse: collapse; font-family: Arial; font-size: 12px;">';
        bodyHTML += '<thead style="background: linear-gradient(180deg, #F8F9FA 0%, #E9ECEF 100%); position: sticky; top: 0;">';
        bodyHTML += '<tr>';
        headers.forEach(h => {
            bodyHTML += `<th style="padding: 12px 10px; text-align: left; font-size: 10px; font-weight: 700; color: #495057; text-transform: uppercase; border-bottom: 2px solid #DEE2E6; border-right: 1px solid #DEE2E6; letter-spacing: 0.5px;">${h}</th>`;
        });
        bodyHTML += '</tr></thead>';
        bodyHTML += '<tbody>';
        
        // Show first 10 rows
        const previewRows = rows.slice(0, 10);
        previewRows.forEach((row, idx) => {
            bodyHTML += `<tr style="border-bottom: 1px solid #F1F3F5; background-color: ${idx % 2 === 0 ? '#FFFFFF' : '#F8F9FA'};">`;
            row.forEach((cell, colIdx) => {
                bodyHTML += `<td style="padding: 10px; border-right: 1px solid #F1F3F5; color: #495057;">${cell || '‚Äî'}</td>`;
            });
            bodyHTML += '</tr>';
        });
        
        if (rows.length > 10) {
            bodyHTML += `<tr style="background-color: #FFF3CD;"><td colspan="${headers.length}" style="padding: 12px; text-align: center; color: #856404; font-weight: 600;">üìä Showing first 10 of ${rows.length} items. Upload to process all rows.</td></tr>`;
        }
        
        bodyHTML += '</tbody></table></div></div>';
        
        modalBody.innerHTML = bodyHTML;
        
        // Modal Footer
        const modalFooter = document.createElement('div');
        modalFooter.style.padding = '16px 24px';
        modalFooter.style.backgroundColor = '#FFFFFF';
        modalFooter.style.borderTop = '1px solid #E5E5E5';
        modalFooter.style.display = 'flex';
        modalFooter.style.justifyContent = 'space-between';
        modalFooter.style.alignItems = 'center';
        modalFooter.style.gap = '10px';
        
        const footerLeft = document.createElement('div');
        footerLeft.style.fontSize = '13px';
        footerLeft.style.color = '#666';
        footerLeft.innerHTML = `<i style="margin-right: 8px;">‚ÑπÔ∏è</i>Review the data above before proceeding`;
        
        const footerRight = document.createElement('div');
        footerRight.style.display = 'flex';
        footerRight.style.gap = '10px';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.id = 'csv-cancel-btn';
        cancelBtn.textContent = '‚úï Cancel';
        cancelBtn.style.padding = '10px 20px';
        cancelBtn.style.border = '1px solid #C5C5C5';
        cancelBtn.style.background = '#F5F5F5';
        cancelBtn.style.color = '#333333';
        cancelBtn.style.borderRadius = '6px';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.style.fontFamily = 'Arial';
        cancelBtn.style.fontSize = '14px';
        cancelBtn.style.fontWeight = '500';
        cancelBtn.style.transition = 'all 0.2s';
        cancelBtn.addEventListener('mouseover', () => { cancelBtn.style.backgroundColor = '#E5E5E5'; });
        cancelBtn.addEventListener('mouseout', () => { cancelBtn.style.backgroundColor = '#F5F5F5'; });
        
        footerRight.appendChild(cancelBtn);
        
        if (validationErrors.length === 0) {
            const proceedBtn = document.createElement('button');
            proceedBtn.id = 'csv-proceed-btn';
            proceedBtn.textContent = '‚úì Proceed with Upload';
            proceedBtn.style.padding = '10px 20px';
            proceedBtn.style.border = 'none';
            proceedBtn.style.background = '#70AD47';
            proceedBtn.style.color = '#FFFFFF';
            proceedBtn.style.borderRadius = '6px';
            proceedBtn.style.cursor = 'pointer';
            proceedBtn.style.fontFamily = 'Arial';
            proceedBtn.style.fontSize = '14px';
            proceedBtn.style.fontWeight = '500';
            proceedBtn.style.transition = 'all 0.2s';
            proceedBtn.addEventListener('mouseover', () => { proceedBtn.style.background = '#5A8D38'; });
            proceedBtn.addEventListener('mouseout', () => { proceedBtn.style.background = '#70AD47'; });
            
            footerRight.appendChild(proceedBtn);
        }
        
        modalFooter.appendChild(footerLeft);
        modalFooter.appendChild(footerRight);
        
        // Assemble modal
        previewModal.appendChild(modalHeader);
        previewModal.appendChild(modalBody);
        previewModal.appendChild(modalFooter);
        
        // Add to DOM
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.remove();
                previewModal.remove();
            }
        });
        
        document.body.appendChild(overlay);
        document.body.appendChild(previewModal);
        
        // Handle buttons
        document.getElementById('csv-cancel-btn').addEventListener('click', () => {
            overlay.remove();
            previewModal.remove();
        });
        
        closeBtn.addEventListener('click', () => {
            overlay.remove();
            previewModal.remove();
        });
        
        if (validationErrors.length === 0) {
            document.getElementById('csv-proceed-btn').addEventListener('click', () => {
                overlay.remove();
                previewModal.remove();
                document.getElementById('priceUpdateForm').submit();
            });
        }
    };
    reader.readAsText(file);
}

// Download sample CSV based on price type
document.getElementById('downloadSample').addEventListener('click', function() {
    const priceType = priceTypeSelect.value;
    if (!priceType) {
        showModal({ title: 'Type Required', message: 'Please select a price update type first.', type: 'warning' });
        return;
    }
    
    let headers, sampleRow1, sampleRow2;
    
    switch(priceType) {
        case 'cost':
            headers = 'item_code,units,cost';
            sampleRow1 = '9900127,KGS,7.50';
            sampleRow2 = '9900186,KGS,12.00';
            break;
        case 'mrp':
            headers = 'item_code,units,mrp';
            sampleRow1 = '9900127,KGS,9.95';
            sampleRow2 = '9900186,KGS,15.50';
            break;
        case 'cost_mrp':
            headers = 'item_code,units,cost,mrp';
            sampleRow1 = '9900127,KGS,7.50,9.95';
            sampleRow2 = '9900186,KGS,12.00,15.50';
            break;
        default:
            showModal({ title: 'Invalid Type', message: 'Invalid price type selected.', type: 'error' });
            return;
    }
    
    const csvContent = headers + '\n' + sampleRow1 + '\n' + sampleRow2;
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `price_update_sample_${priceType}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
});

// Platform-based outlet filtering
document.getElementById('platform').addEventListener('change', function() {
    const platform = this.value;
    const outletSelect = document.getElementById('outlet');
    
    if (platform) {
        // Clear current outlet options and show loading
        outletSelect.innerHTML = '<option value="">Loading outlets...</option>';
        
        // Fetch outlets for selected platform
        fetch(`/integration/api/outlets-by-platform/?platform=${platform}`)
            .then(response => response.json())
            .then(data => {
                outletSelect.innerHTML = '<option value="">Select Outlet</option>';
                
                data.outlets.forEach(outlet => {
                    const option = document.createElement('option');
                    option.value = outlet.id;
                    option.textContent = `${outlet.name} - ${outlet.location}`;
                    outletSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching outlets:', error);
                outletSelect.innerHTML = '<option value="">Error loading outlets</option>';
            });
    } else {
        // Clear outlets when no platform is selected
        outletSelect.innerHTML = '<option value="">Select a platform first</option>';
    }
});

// Form validation - Direct submit (no preview)
document.getElementById('priceUpdateForm').addEventListener('submit', function(e) {
    const platform = document.getElementById('platform').value;
    const outlet = document.getElementById('outlet').value;
    const priceType = document.getElementById('price_type').value;
    const csvFile = document.getElementById('csv_file').files[0];
    
    if (!platform || !outlet || !priceType || !csvFile) {
        e.preventDefault();
        showModal({ title: 'Missing Inputs', message: 'Please fill all required fields and select a CSV file.', type: 'warning' });
        return;
    }
    
    // Allow form to submit directly (no preview)
    // Form will submit to backend for processing
});

// Preview button - Show CSV preview modal (optional)
document.getElementById('previewBtn').addEventListener('click', function(e) {
    e.preventDefault();
    
    const platform = document.getElementById('platform').value;
    const outlet = document.getElementById('outlet').value;
    const priceType = document.getElementById('price_type').value;
    const csvFile = document.getElementById('csv_file').files[0];
    
    if (!platform || !outlet || !priceType || !csvFile) {
        showModal({ title: 'Missing Inputs', message: 'Please fill all required fields and select a CSV file.', type: 'warning' });
        return;
    }
    
    // Show CSV preview modal
    showCSVPreview(csvFile);
});
</script>
{% endblock %}